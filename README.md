# Pixel Sorting Morphing

![](./morphing.gif)

## 概要

これは、ある画像（入力画像）を、別の画像（目標画像）の構造に再構成するモーフィング・アニメーションを生成する Python スクリプトです。

本プログラムの特徴は、入力画像のピクセルを一つも変更することなく、その**位置を入れ替える**だけで目標画像を再構成する点にあります。ピクセルの移動先は、2 つの画像間での「輝度」または「色相」の順位（ランク）に基づいて決定されます。

このアルゴリズムは、学術的な概念である「最適輸送問題」や「ヒストグラムマッチング」を、直感的で視覚的に面白い効果として実装したものです。

---

## 🌟 機能

- **ピクセル再配置によるモーフィング**: ピクセルの色を変えずに、移動だけで画像を滑らかに変形させます。
- **自動収束**: アニメーションは、全てのピクセルが目標位置に到達するまで自動で実行されます。
- **イーズイン・イーズアウト効果**: アニメーションの開始と終了がゆっくりになるよう調整し、自然な動きを表現します。
- **GIF 出力**: 生成されたアニメーションは GIF ファイルとして保存されます。

---

## REQUIREMENTS

- Python 3.6 以上
- 必要なライブラリ:
  - NumPy
  - Pillow (PIL)
  - Matplotlib
  - tqdm

---

## 🛠️ 使い方

### 1\. インストール

まず、プロジェクトをクローンするか、ファイルをダウンロードします。
その後、必要な Python ライブラリをインストールします。

```bash
pip install numpy pillow matplotlib tqdm
```

### 2\. 画像の準備

プロジェクトのルートディレクトリに、2 枚の画像を用意します。

- `input.png`: **モーフィングさせたい元の画像**
- `target.png`: **目標とする構造を持つ画像**

※ もし画像が存在しない場合、初回実行時にサンプル画像が自動で生成されます。

### 3\. プログラムの実行

ターミナルで以下のコマンドを実行します。

```bash
python morphing.py
```

プログラムの `main` 関数内にある以下の変数を変更することで、動作をカスタマイズできます。

```python
def main():

    # --- パラメータ設定 ---
    TARGET_IMAGE_PATH = 'target.png'
    INPUT_IMAGE_PATH = 'input.png'
    IMAGE_SIZE = (128, 128)  # 解像度 (大きいほど計算時間がかかる)
    OUTPUT_GIF_PATH = f'morphing.gif'
    MAX_FRAMES = 1000        # シミュレーションの最大フレーム数 (無限ループ防止)
    ANIMATION_FRAMES = 300   # 出力するGIFの総フレーム数
    ANIMATION_FPS = 30       # GIFのフレームレート (滑らかさ)

    # (以下略)
```

---

## 🔬 アルゴリズムについて

このプログラムは、大きく分けて 2 つのフェーズで動作します。

1.  **シミュレーションフェーズ**:

    - まず、入力画像と目標画像の各ピクセルを一次元のベクトにして、濃度の値でソートします。
    - 「入力画像の N 番目のピクセル」が「目標画像の N 番目のピクセルの**位置**」に移動するように、全ピクセルのゴール地点を決定します (空間的ヒストグラムマッチング)。
    - 全ピクセルがゴールに到達するまで、1 フレームずつ移動シミュレーションを行います。衝突が発生した場合は、ゴールから最も遠いピクセルが優先的に移動します (最適輸送問題の近似解法)。
    - このシミュレーションにおける、全フレームの全ピクセルの位置情報を履歴として保存します。

2.  **描画・保存フェーズ**:

    - シミュレーションで保存した位置情報の履歴に、イーズイン・イーズアウト効果を適用して、再生フレームを調整します。
    - 調整後のフレーム履歴に基づき、各フレームの画像を再描画し、最終的な GIF アニメーションとして保存します。

このアプローチにより、ピクセルの動きを事前に計算し、滑らかで確実に収束するアニメーションを効率的に生成しています。

## 参考文献
プログラムで利用した画像はウィキペディア・コモンズのパブリックドメインを用いました
- [input : Aurora_borealis_over_Eielson_Air_Force_Base,_Alaska](https://commons.wikimedia.org/wiki/Category:Featured_photographs_in_the_public_domain#/media/File:Aurora_borealis_over_Eielson_Air_Force_Base,_Alaska.jpg)
- [target : President_Barack_Obama_(crop)](https://commons.wikimedia.org/wiki/Category:Featured_photographs_in_the_public_domain#/media/File:President_Barack_Obama_(crop).jpg)